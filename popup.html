<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Protheus Monitor Manager</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    html, body {
      width: 100%;
      min-width: 740px;
      max-height: auto;
      overflow-y: auto;
      margin: 0;
      padding: 8px;
      transition: background-color 0.3s, color 0.3s;
    }

    /* Tema claro */
    body.theme-light {
      background-color: #ffffff;
      color: #212529;
    }

    /* Tema escuro */
    body.theme-dark {
      background-color: #121212;
      color: #e0e0e0;
    }

    /* Corrige cor de cards e textos no modo escuro */
    .theme-dark .card {
      border-color: #333;
    }

    .theme-dark .card .card-body {
      background-color: #1e1e1e;
      color: #ffffff;
    }
    
    .theme-dark .card-header {
      background-color: #333 !important;
      border-color: #333;
    }

    .theme-dark .card .card-body .text-muted {
      color: #aaaaaa !important;
    }
    
    .theme-dark .btn-outline-light {
      color: #f8f9fa;
      border-color: #f8f9fa;
    }
    
    .theme-dark .btn-outline-light:hover {
      background-color: #f8f9fa;
      color: #121212;
    }

    pre#logs {
      /* Estilos do console */
      height: 70vh !important;
      overflow-y: auto !important;
      background-color: #111 !important;
      color: #bfb !important;
      padding: 8px !important;
      border-radius: 6px !important;
      font-family: monospace !important;
      margin-top: 10px !important;
      white-space: pre-wrap; 
      word-break: break-word;
    }

    #alertArea {
      margin-bottom: 8px;
    }
  </style>
</head>

<body class="theme-light">
  <div class="container-fluid">
    <div class="d-flex align-items-center mb-2">
      <h5 class="mb-0">
        <img style="padding-right: 10px;" src="icons/48.png" alt="Logo" />
        Protheus Monitor Manager - Multi Agent v1.0 &nbsp;&nbsp;
      </h5>
      <button id="btnRefreshAll" class="btn btn-sm btn-outline-secondary ms-auto me-1" title="Atualizar Agentes e WebApps">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
      <button id="btnOpenWindow" class="btn btn-sm btn-outline-secondary me-1" title="Abrir em Nova Janela">
        <i class="bi bi-window"></i>
      </button>
      <button class="btn btn-sm btn-outline-secondary" id="toggleTheme" title="Alternar Tema">
        <i class="bi bi-toggles"></i>
      </button>
    </div>

    <div id="alertArea"></div>

    <div class="card mt-3">
      <div class="card-header bg-secondary text-white">
        <i class="bi bi-hdd-rack"></i> Servers
        <button id="btnAddAgent" class="btn btn-sm btn-light float-end">+ Adicionar</button>
      </div>
      <div class="card-body">
        <div id="agentList" class="mb-2">Carregando agentes...</div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header bg-secondary text-white">
        <i class="bi bi-globe2"></i> WebApps
        <button id="btnAddWebApp" class="btn btn-sm btn-light float-end">+ Adicionar</button>
      </div>
      <div class="card-body" id="webappList">
        <div class="text-muted">Carregando...</div>
      </div>
    </div>

    <footer><small>Desenvolvido por <a href="https://github.com/LeonardoMarconi" target="_blank">Leonardo Marconi</a></small></footer>
  </div>

  <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="logModalLabel"><i class="bi bi-file-code"></i> Console Log</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            </div>
          <pre id="logs" class="p-2 rounded">
[Conecte-se a um serviço para visualizar o log]
          </pre>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button id="btnClearLog" type="button" class="btn btn-outline-light">Limpar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="popup.js"></script>

  <script>
    // Lógica para controle do tema.
    const btnTheme = document.getElementById('toggleTheme');
    const body = document.body;

    /** Aplica o tema salvo em `chrome.storage.local`. */
    async function applySavedTheme() {
      const saved = await chrome.storage.local.get('theme');
      const theme = saved.theme || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      setTheme(theme);
    }

    /** Define o tema e atualiza o botão. */
    function setTheme(theme) {
      body.classList.remove('theme-light', 'theme-dark');
      body.classList.add('theme-' + theme);
      btnTheme.innerHTML = theme === 'dark' ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon"></i>';
    }

    btnTheme.addEventListener('click', async () => {
      const newTheme = body.classList.contains('theme-dark') ? 'light' : 'dark';
      setTheme(newTheme);
      await chrome.storage.local.set({ theme: newTheme });
    });

    applySavedTheme();
  </script>
</body>
</html>